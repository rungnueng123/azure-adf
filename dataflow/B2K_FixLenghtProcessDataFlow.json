{
	"name": "B2K_FixLenghtProcessDataFlow",
	"properties": {
		"folder": {
			"name": "B2KMPS"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "B2K_MCRMRCH",
						"type": "DatasetReference"
					},
					"name": "mcrmrchFixedLength"
				},
				{
					"dataset": {
						"referenceName": "B2K_EDCTERM",
						"type": "DatasetReference"
					},
					"name": "edctermFixedLength"
				},
				{
					"dataset": {
						"referenceName": "B2K_EMSMRMST",
						"type": "DatasetReference"
					},
					"name": "emsmrmstFixedLength"
				},
				{
					"dataset": {
						"referenceName": "B2K_IMPORT_MERCHANT_PROFILE",
						"type": "DatasetReference"
					},
					"name": "importMerchantProfile"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "B2K_MCRMRCH_OUTPUT",
						"type": "DatasetReference"
					},
					"name": "mcrmrchSink"
				},
				{
					"dataset": {
						"referenceName": "B2K_EDCTERM_OUTPUT",
						"type": "DatasetReference"
					},
					"name": "edctermSink"
				},
				{
					"dataset": {
						"referenceName": "B2K_EMSMRMST_OUTPUT",
						"type": "DatasetReference"
					},
					"name": "emsmrmstSink"
				},
				{
					"dataset": {
						"referenceName": "B2K_MCRMRCH_FILTER_ERROR",
						"type": "DatasetReference"
					},
					"name": "mcrmrchFilterFailSink"
				},
				{
					"dataset": {
						"referenceName": "B2K_EDCTERM_DATA_ERROR",
						"type": "DatasetReference"
					},
					"name": "edctermFailSink"
				},
				{
					"dataset": {
						"referenceName": "B2K_EMSMRMST_DATA_ERROR",
						"type": "DatasetReference"
					},
					"name": "emsmrmstFailSink"
				},
				{
					"dataset": {
						"referenceName": "B2K_EDCTERM_FILTER_ERROR",
						"type": "DatasetReference"
					},
					"name": "edctermFilterFailSink"
				},
				{
					"dataset": {
						"referenceName": "B2K_MCRMRCH_DATA_ERROR",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "edctermDerivedFixedLength"
				},
				{
					"name": "edctermOutputFixedLength"
				},
				{
					"name": "emsmrmstColumn1"
				},
				{
					"name": "emsmrmstOutputFixedLength"
				},
				{
					"name": "filterSequenceKey"
				},
				{
					"name": "filterSequence"
				},
				{
					"name": "mcrmrchFilterCheck"
				},
				{
					"name": "edctermDataCheck"
				},
				{
					"name": "emsmrmstDataCheck"
				},
				{
					"name": "edctermFilterCheck"
				},
				{
					"name": "joinImpMercProf1"
				},
				{
					"name": "joinImpMercProf2"
				},
				{
					"name": "joinImpMercProf3"
				},
				{
					"name": "mcrmrchDataCheck"
				},
				{
					"name": "mcrmrchFailDerived"
				},
				{
					"name": "mcrmrchFailAggregate"
				},
				{
					"name": "mcrmrchFailDerived2"
				},
				{
					"name": "mcrmrchFailAggregate2"
				},
				{
					"name": "mcrmrchErrorFlatten"
				},
				{
					"name": "mcrmrchErrorFlatten2"
				},
				{
					"name": "mcrmrchErrorSelect"
				},
				{
					"name": "mcrmrchErrorDerivedFixedLength"
				},
				{
					"name": "mcrmrchDerivedFixedLength"
				},
				{
					"name": "union1"
				},
				{
					"name": "derivedColumn1"
				}
			],
			"scriptLines": [
				"parameters{",
				"     UPDATE_DATE as string (toString(currentTimestamp())),",
				"     FileErrorDate as string ('')",
				"}",
				"source(output(",
				"          data as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> mcrmrchFixedLength",
				"source(output(",
				"          data as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> edctermFixedLength",
				"source(output(",
				"          data as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> emsmrmstFixedLength",
				"source(output(",
				"          MID_L11 as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> importMerchantProfile",
				"edctermDataCheck@edctermDataPass derive(MERCHANT_ID = trim(substring(data, 11, 16)),",
				"          Terminal_ID = trim(substring(data, 1, 8)),",
				"          Terminal_Name_EN = iif(equals(toString(length(trim(substring(data, 30, 30)))), '0'), ' ', trim(substring(data, 30, 30))),",
				"          Terminal_Name_TH = iif(equals(toString(length(trim(substring(data, 30, 30)))), '0'), ' ', trim(substring(data, 30, 30))),",
				"          UPDATE_DATE = $UPDATE_DATE,",
				"          ACTIVE_STATUS = 'A',",
				"          MID_L11 = trim(substring(data, 11, 11))) ~> edctermDerivedFixedLength",
				"edctermDerivedFixedLength select(mapColumn(",
				"          data,",
				"          MERCHANT_ID,",
				"          Terminal_ID,",
				"          Terminal_Name_EN,",
				"          Terminal_Name_TH,",
				"          UPDATE_DATE,",
				"          ACTIVE_STATUS,",
				"          MID_L11",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> edctermOutputFixedLength",
				"emsmrmstDataCheck@emsmrmstDataPass derive(BILLER_MERCHANT_ID = trim(substring(data, 3, 16)),",
				"          EMAIL_1 = iif(equals(toString(length(trim(substring(data, 24, 70)))), '0'), ' ', trim(substring(data, 24, 70))),",
				"          EMAIL_2 = iif(equals(toString(length(trim(substring(data, 94, 70)))), '0'), ' ', trim(substring(data, 94, 70))),",
				"          EMAIL_3 = iif(equals(toString(length(trim(substring(data, 164, 70)))), '0'), ' ', trim(substring(data, 164, 70))),",
				"          MID_L11 = trim(substring(data, 3, 11))) ~> emsmrmstColumn1",
				"emsmrmstColumn1 select(mapColumn(",
				"          data,",
				"          BILLER_MERCHANT_ID,",
				"          EMAIL_1,",
				"          EMAIL_2,",
				"          EMAIL_3,",
				"          MID_L11",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> emsmrmstOutputFixedLength",
				"mcrmrchFilterCheck@mcrmrchFilterPass filter(BILLER_MERCHANT_ID != '' && ACCOUNT_ID != '' && TAX_ID != '' && NAME_TH != '' && NAME_EN != '') ~> filterSequenceKey",
				"edctermFilterCheck@edctermFilterPass filter(MERCHANT_ID != '' && Terminal_ID != '' && Terminal_Name_EN != '' && Terminal_Name_TH != '') ~> filterSequence",
				"union1 split(length(BILLER_MERCHANT_ID) > 0 && length(ACCOUNT_ID) > 0 && length(TAX_ID) > 0 && length(NAME_TH) > 0 && length(NAME_EN) > 0,",
				"     disjoint: false) ~> mcrmrchFilterCheck@(mcrmrchFilterPass, mcrmrchFilterFail)",
				"edctermFixedLength split(length(data) == 450,",
				"     disjoint: false) ~> edctermDataCheck@(edctermDataPass, edctermDataFail)",
				"emsmrmstFixedLength split(length(data) >= 234,",
				"     disjoint: false) ~> emsmrmstDataCheck@(emsmrmstDataPass, emsmrmstDatafail)",
				"edctermOutputFixedLength split(length(MERCHANT_ID) > 0 && length(Terminal_ID) > 0,",
				"     disjoint: false) ~> edctermFilterCheck@(edctermFilterPass, edctermFilterFail)",
				"filterSequenceKey, importMerchantProfile join(mcrmrchFilterCheck@mcrmrchFilterPass@MID_L11 == importMerchantProfile@MID_L11,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinImpMercProf1",
				"filterSequence, importMerchantProfile join(edctermFilterCheck@edctermFilterPass@MID_L11 == importMerchantProfile@MID_L11,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinImpMercProf2",
				"emsmrmstOutputFixedLength, importMerchantProfile join(emsmrmstOutputFixedLength@MID_L11 == importMerchantProfile@MID_L11,",
				"     joinType:'inner',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinImpMercProf3",
				"mcrmrchFixedLength split(length(data) == 1200,",
				"     disjoint: false) ~> mcrmrchDataCheck@(mcrmrchDataPass, mcrmrchDataFail)",
				"mcrmrchDataCheck@mcrmrchDataFail derive(Key = toLong(1),",
				"          data = data) ~> mcrmrchFailDerived",
				"mcrmrchFailDerived aggregate(groupBy(Key),",
				"     data = collect(data)) ~> mcrmrchFailAggregate",
				"mcrmrchFailAggregate derive(data = split(replace(replace(replace(replace(toString(data),'\",\"01','\u000101'),'\",\"',' '),'[\"',''),'\"]',''), '\u0001')) ~> mcrmrchFailDerived2",
				"mcrmrchFailDerived2 aggregate(groupBy(Key),",
				"     data = topN(data,Key,1)) ~> mcrmrchFailAggregate2",
				"mcrmrchFailAggregate2 foldDown(unroll(data),",
				"     mapColumn(",
				"          Key,",
				"          data = data.value",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> mcrmrchErrorFlatten",
				"mcrmrchErrorFlatten foldDown(unroll(data),",
				"     mapColumn(",
				"          Key,",
				"          data",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> mcrmrchErrorFlatten2",
				"mcrmrchErrorFlatten2 select(mapColumn(",
				"          data",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> mcrmrchErrorSelect",
				"derivedColumn1 derive(BILLER_MERCHANT_ID = trim(substring(data, 3, 16)),",
				"          ACCOUNT_ID = trim(substring(data, add(310,diffLength), 10)),",
				"          TAX_ID = trim(substring(data, add(988,diffLength), 13)),",
				"          NAME_TH = trim(substring(data, add(1029,diffLength), 40)),",
				"          NAME_EN = trim(substring(data, 23, 30)),",
				"          ACTIVE_STATUS = case(or(substring(data, 210, 1) == '2', substring(data, 210, 1) == '5'), 'A', 'I'),",
				"          UPDATE_DATE = $UPDATE_DATE,",
				"          SOURCE = \"B2K\",",
				"          MID_L11 = trim(substring(data, 3, 11))) ~> mcrmrchErrorDerivedFixedLength",
				"mcrmrchDataCheck@mcrmrchDataPass derive(BILLER_MERCHANT_ID = trim(substring(data, 3, 16)),",
				"          ACCOUNT_ID = trim(substring(data, 310, 10)),",
				"          TAX_ID = trim(substring(data, 988, 13)),",
				"          NAME_TH = trim(substring(data, 1029, 40)),",
				"          NAME_EN = trim(substring(data, 23, 30)),",
				"          ACTIVE_STATUS = case(or(substring(data, 210, 1) == '2', substring(data, 210, 1) == '5'), 'A', 'I'),",
				"          UPDATE_DATE = $UPDATE_DATE,",
				"          SOURCE = \"B2K\",",
				"          MID_L11 = trim(substring(data, 3, 11))) ~> mcrmrchDerivedFixedLength",
				"mcrmrchDerivedFixedLength, mcrmrchErrorDerivedFixedLength union(byName: true)~> union1",
				"mcrmrchErrorSelect derive(data = data,",
				"          diffLength = iif(length(trim(substring(data, 305, 15))) == 15, 0, iif(length(trim(substring(data, 305, 1))) == 1, -minus(15, length(trim(substring(data, 305, 15)))), minus(15, length(trim(substring(data, 305, 15)))))),",
				"          column1 = length(data),",
				"          column2 = substring(data, 305, 15)) ~> derivedColumn1",
				"joinImpMercProf1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['B2K_MCRMRCH_TEMP.txt'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          BILLER_MERCHANT_ID,",
				"          ACCOUNT_ID,",
				"          TAX_ID,",
				"          NAME_TH,",
				"          NAME_EN,",
				"          ACTIVE_STATUS,",
				"          UPDATE_DATE,",
				"          SOURCE",
				"     ),",
				"     partitionBy('hash', 1)) ~> mcrmrchSink",
				"joinImpMercProf2 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['B2K_EDCTERM_TEMP.txt'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          MERCHANT_ID,",
				"          Terminal_ID,",
				"          Terminal_Name_EN,",
				"          Terminal_Name_TH,",
				"          UPDATE_DATE,",
				"          ACTIVE_STATUS",
				"     ),",
				"     partitionBy('hash', 1)) ~> edctermSink",
				"joinImpMercProf3 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['B2K_EMSMRMST_TEMP.txt'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          BILLER_MERCHANT_ID,",
				"          EMAIL_1,",
				"          EMAIL_2,",
				"          EMAIL_3",
				"     ),",
				"     partitionBy('hash', 1)) ~> emsmrmstSink",
				"mcrmrchFilterCheck@mcrmrchFilterFail sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:[(concat(\r",
				"    'B2K_MCRMRCH_FILTER_ERROR_',\r",
				"    $FileErrorDate,\r",
				"    '.csv'\r",
				"))],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          BILLER_MERCHANT_ID,",
				"          ACCOUNT_ID,",
				"          TAX_ID,",
				"          NAME_TH,",
				"          NAME_EN,",
				"          ACTIVE_STATUS,",
				"          UPDATE_DATE,",
				"          SOURCE",
				"     ),",
				"     partitionBy('hash', 1)) ~> mcrmrchFilterFailSink",
				"edctermDataCheck@edctermDataFail sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:[(concat(\r",
				"    'B2K_EDCTERM_DATA_ERROR_',\r",
				"    $FileErrorDate,\r",
				"    '.txt'\r",
				"))],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> edctermFailSink",
				"emsmrmstDataCheck@emsmrmstDatafail sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:[(concat(\r",
				"    'B2K_EMSMRMST_DATA_ERROR_',\r",
				"    $FileErrorDate,\r",
				"    '.txt'\r",
				"))],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> emsmrmstFailSink",
				"edctermFilterCheck@edctermFilterFail sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:[(concat(\r",
				"    'B2K_EDCTERM_FILTER_ERROR_',\r",
				"    $FileErrorDate,\r",
				"    '.csv'\r",
				"))],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          MERCHANT_ID,",
				"          Terminal_ID,",
				"          Terminal_Name_EN,",
				"          Terminal_Name_TH,",
				"          UPDATE_DATE,",
				"          ACTIVE_STATUS",
				"     ),",
				"     partitionBy('hash', 1)) ~> edctermFilterFailSink",
				"mcrmrchErrorSelect sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['test.txt'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> sink1"
			]
		}
	}
}